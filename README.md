# D Web開発

あくまで構想

## 構成(例)

- リバースプロキシ(nginx,h2o),アプリケーションサーバ(vibe.d),データベース(MySQL,Postgres)の3層構成が基本
  - そこに非同期ジョブキューやバッチ処理などが加わる場合もある
  - 規模が大きくなってくるとキャッシュ層としてmemcachedやredisを使ったりすることもある
  - 規模が大きくなってくるとCDNやロードバランサなどを前段に配置することもある

### リバースプロキシ

- ここではnginxを想定
  - アプリケーションサーバの前段でバランシング
  - 静的ファイルの配信
  - SSLの終端
  - gzip圧縮
  - リダイレクト
  - レスポンスヘッダの細工

### アプリケーションサーバ

- vibe.d
  - 1台もしくは複数台のサーバを並べる
    - 1台で複数のアプリケーションサーバを別ポートでlistenする
    - 複数台並べてそれぞれ1個のアプリケーションサーバを起動する
  - 非同期I/Oベースなのでブロックしないような工夫が必要
    - ディスクI/Oは別スレッドで処理を行うなど

### データベース

- ここではMySQL or Postgresを想定
  - 接続にはコネクションプールを使う
  - 基本的にクエリのチューニングやレプリケーションなど勘所は他の言語と一緒
  - レプリケーションなど負荷対策も同様

### ジョブキュー

- DBへの重いリクエストジョブキューに積んで非同期実行させる
  - クライアントへのレスポンスが遅延しないようにするため
  - ウェブサーバはジョブキューの完了を待たない
- Dには使えそうなジョブキュー実装がない
  - 言語非依存なものとしてfireworqなどがあるのでそれが使えるかもしれない

### バッチ処理

- 定期的に行いたい処理をcronに登録しておく

### キャッシュ

- 負荷対策としてキャッシュを用いることを考える
  - DBアクセスの負荷対策: redisなどのKVSを使う
  - ネットワークアクセスを減らす: ブラウザキャッシュ(Cache-Control)やCloudFrontなどのCDN
  - 状況によってはアプリケーションサーバ内部にオンメモリキャッシュを備えるなども考慮する

---

## コード

たとえばこういうことを考えてコードを書く

### テスト

- テストしやすいデザインを目指すには
  - コントローラーのテストを薄めに
    - テストダブル(Mock,Spy,Fake)を使ってDBを使わない軽量な方法にできないか検討する
  - モデル層は厚くテストする
    - fixtureを使ってDBを使ったテストにしたい
- より詳しいことは [my thought of testing](./testing/my_thought_of_testing.md) に

### Adapter Pattern

- vibe.dはORMのような抽象化層を提供しない
- hibernatedのようなORMはあるが使いやすいとはいえない
- 自前で薄い抽象化層をDatabaseAdapterとして作るのがよさそう
  - 実際に使う操作のみ提供するように(全部の機能に対して最初から用意しない)
  - 抽象化層があれば後でDBの変更がしやすい

---

## 運用

### プロファイリング,モニタリング

- プロファイリングは自分たちで頑張る部分が多い
- CPUプロファイリング
  - GoのpprofやRubyのrack-lineprofのような使いごこちのものは期待できない
  - CPUプロファイルはperfやoprofile,google-perftoolsなどから選定
  - Goのpprofのように使えるものを作る？
- メモリプロファイリング
  - メモリプロファイリングはcore.memoryやmallinfo(3)などが使える
- モニタリングに関しては他の言語とほぼ同じだが使える外部サービスは限定されるかも

### デプロイ,プロビジョニング

- docker,ansible,単純にrsyncなど方法はいろいろある
- dockerを使う場合
  - 公式のイメージを使うとよさそう
  - 実行バイナリのみ配布ができる
    - 動的に依存するライブラリは `ldd` や `pldd` などで確認

### スキーママイグレーション

- これも今の所決定的なツールはない
  - 別の言語の資産を使うことも考える
  - 自作する場合はrails-likeなものにするかGitDLL的なものにするか
